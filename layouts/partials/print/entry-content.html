{{- $page := . -}}

{{- if or (not (isset .Params "type")) (and (isset .Params "type") (ne .Params.type "hanger")) -}}
  {{- .Content -}}
{{- else -}}

  <h2 class="heading-imprint">{{ i18n "print" }}</h2>
  <div class="hanger-content">
    {{- if ne .Content "" -}}
      <p>
        {{- .RawContent | safeHTML -}}
      </p>
      {{- else -}} 
      <p class="noImprint">
        {{ i18n "noTitle" }}
      </p> 
    {{- end -}}
  </div>
  

  {{- $additional := "" -}}

  {{- $place := "" -}}
  {{- $features := slice -}}
  {{- $tagContent := "" -}}
  {{- $changed := false -}}

  {{- range $tag := .Params.tags -}}
    {{- if ne $tag "" -}}
      {{- $tagUrl := printf "%s%s" "tags/" ($tag | urlize) -}}
      {{- if or (strings.Contains $tag " ") (strings.Contains $tag "& ") -}}
        {{- $tagUrl = printf "%s%s" "tags/" ((replace (replace $tag "& " "-") " " "-") | urlize) -}}
      {{- end -}}
      {{- $tagPath := (urls.Parse $tagUrl).Path -}}

      {{- $tagPage := false -}}
      {{- with site.GetPage $tagPath -}}
        {{- $tagPage = . -}}
      {{- else -}}
        {{- $termPages := site.Pages -}}
        {{- range site.Home.Translations -}}
          {{- $termPages = $termPages | lang.Merge site.Pages -}}
        {{- end -}}
        {{- $termPages = where $termPages ".Kind" "eq" "term" -}}
        {{- $alias := printf "/%s" $tagPath -}}
        {{- $termPages = where $termPages ".Aliases" "intersect" (slice $alias) -}}
        {{- $tagPage = index $termPages 0 -}}
      {{- end -}}

      {{- with $tagPage -}}
        {{- if isset .Params "type" -}}
          {{- if or (eq .Params.type "store") (eq .Params.type "retail_chain") -}}
            {{- if ne .Content "" -}}
              {{- $tagContent = printf `%s<div class="tag-content">%s</div>` $tagContent (.RawContent | $.Page.RenderString) -}}
            {{- end -}}
          {{- end -}}
          {{- if eq .Params.type "place" -}}
            {{- $place = .Title -}}
          {{- end -}}
          {{- if eq .Params.type "feature" -}}
            {{- $features = $features | append .Title -}}
          {{- end -}}
        {{- end -}}
      {{- else -}}
        {{- errorf "[print/entry-content.html] Can't find term page for %s (file %s) from %s" $tag $tagPath $page.RelPermalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if ne $place "" -}}
    {{- $additional = printf `%s<div class="place"><div class="additional-header">%s: </div>%s</div>` $additional (i18n "place" ) $place -}}
    {{ $changed = true -}}
  {{- end -}}

  {{- if gt (len $features) 0 -}}
    {{- $featureTitles := delimit $features ", " -}}
    {{- $additional = printf `%s<div class="features"><div class="additional-header">%s: </div>%s</div>` $additional (i18n "features" (len $features) ) $featureTitles -}}
    {{ $changed = true -}}
    {{- end -}}

  {{- if ne $tagContent "" -}}
    {{- $additional = printf `%s%s` $additional $tagContent -}}
    {{ $changed = true -}}
  {{- end -}}

  {{- with .Params.remarks -}}
    {{- $remarks := . -}}
    {{- $remarks = replace $remarks "Aktuelle Webseite" (i18n "currentWebsite") -}}
    {{- $remarks = replace $remarks "Heutige Webseite" (i18n "currentWebsite") -}}
    {{- $remarks = replace $remarks "Aktuelle Homepage" (i18n "currentWebsite") -}}
    {{- $remarks = replace $remarks "Heutige Homepage" (i18n "currentWebsite") -}}
    {{- $remarks = replace $remarks "Derzeitige Homepage" (i18n "currentWebsite") -}}
    {{- $additional = printf `%s<div class="remarks notes"><div class="additional-header">%s:</div>%s</div>` $additional (i18n "remarks") ($remarks | $.Page.RenderString) -}}
    {{ $changed = true -}}
    {{- end -}}

  {{- with .Params.related -}}
    {{- if reflect.IsSlice . -}}
      {{- $additional = printf "%s%s" $additional (partial "print/related.html" $page) -}}
    {{- else -}}
      {{- $additional = printf "%s%s" $additional ( . | $.Page.RenderString)  -}}
      {{- errorf "[print/entry-content.html] Unexpected type for related, should be slice" -}}
    {{- end -}}
    {{ $changed = true -}}
  {{- end -}}

  {{- with .Params.source -}}
    {{- $additional = printf `%s<div class="source"><div class="additional-header">%s:</div>%s</div>` $additional (i18n "source" ) ( . | $.Page.RenderString) -}}
  {{- end -}}
  {{- with .Params.donation -}}
    {{- $additional = printf `%s<div class="donation"><div class="additional-header">%s:</div>%s</div>` $additional (i18n "donation" ) ( . | $.Page.RenderString) -}}
  {{- end -}}

  {{- if ne $additional "" -}}
    {{- if $changed -}}
      <h2 class="heading-info">{{ i18n "info" }}</h2>
    {{- end -}}
    <div class="additional-content">
      {{- $additional | safeHTML -}}
    </div>
  {{- end -}}
{{- end -}}
